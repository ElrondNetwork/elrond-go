language: go

go: "1.13"

os:
- linux
- osx

arch:
- amd64
- arm64

osx_image: xcode11.3

before_script:
- APP_VER=$(git describe --tags --long --dirty)
- APP_VER_SHORT=$(git describe --tags)
- GOOS=$(go env GOOS)
- GOARCH=$(go env GOARCH)
- ARCHIVE="elrond_""$APP_VER_SHORT""_""$GOOS""_""$GOARCH"".tgz"

script:
- ERD_PACKAGE=node
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- ERD_PACKAGE=keygenerator
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- ERD_PACKAGE=logviewer
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- ERD_PACKAGE=termui
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- cd $TRAVIS_BUILD_DIR 
- ARWEN_PATH=$TRAVIS_BUILD_DIR/build/arwen make arwen

- GOOS=$(go env GOOS)
- GOARCH=$(go env GOARCH)
- cd $TRAVIS_BUILD_DIR
- ARWEN_VERSION=$(cat go.mod | grep arwen | sed 's/^.*arwen-wasm-vm *//')
- if [[ "$GOOS" == linux && "$GOARCH" == amd64 ]]; then
    cp -f $GOPATH/pkg/mod/github.com/\!elrond\!network/arwen-wasm-vm@$ARWEN_VERSION/wasmer/libwasmer_linux_amd64.so $TRAVIS_BUILD_DIR/build;
  fi
- if [[ "$GOOS" == linux && "$GOARCH" == arm64 ]]; then
    cp -f $GOPATH/pkg/mod/github.com/\!elrond\!network/arwen-wasm-vm@$ARWEN_VERSION/wasmer/libwasmer_linux_arm64.so $TRAVIS_BUILD_DIR/build;
  fi
- if [[ "$GOOS" == darwin && "$GOARCH" == amd64 ]]; then
    cp -f $GOPATH/pkg/mod/github.com/\!elrond\!network/arwen-wasm-vm@$ARWEN_VERSION/wasmer/libwasmer_darwin_amd64.dylib $TRAVIS_BUILD_DIR/build;
  fi

before_deploy:
- cd "$TRAVIS_BUILD_DIR/build"
- tar czvf "$TRAVIS_BUILD_DIR/$ARCHIVE" *

after_deploy:
- rm -rf "$TRAVIS_BUILD_DIR/build"
- rm -rf "$TRAVIS_BUILD_DIR/$ARCHIVE"

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: GuqrRzf4YSx/+b6/wrxNj5aFjFZAW6onY5eedWNA2R/5DRvS+2nGa3SZ8drKI87jpSWWqIjmRmRfBzigdvSloXb7gKWnVYZLtZGgtplZhsCbIjMy3bweXrqYf/iTBSWpdlgrooRwqdoMDtgLv/dx6xFCFOjONulTahVSMi6FJpN7XYsLCdevrS2QQKq80AaOuveUb+DLqzfruc4/MXBHg8dQ+pBA5rRKZ+yJp1uLKgUSb82Ape1p5iiUv7eAG8LzUb80/sTuUkQAA7eyXMH8wPaXWV/d1tejE5jmdAutZGRodv6F6LjPvU35qA4n8HUne8sU7cedv2ofT7tdMH/aoKwPWbzHJd6WYiqQ/nGqpaR0iTU/Gt21rhpEVzGBtHDvARTGrgJxRRXqD05aSwbR4dtY5VCnjOghSDVpNPmsP9PTQS/ooA4KUMhpk7gjrvmDnMbSuYGuf171pqjACs1V+pcuQjIXVwDYERdr7SqBAETn6eaV9368NZk7upI/USqHwEwh4t+x6ccDvt1qHpoLvLZBExxmhWuz3gHqfJaMcxYXVFtouL576I/BuHdyk4/xxdW+tZnwOYa3iybTobqsHDcpZoFtD/nM5iZVetUXwwGz1OZTf85iB7QhPQluxXIuGc6vDDv53FBF0sVvlcmR9tPU1NlPkcR5lRtANpeAnJY=
  file: "$TRAVIS_BUILD_DIR/$ARCHIVE"
  draft: true
  on:
    tags: true
