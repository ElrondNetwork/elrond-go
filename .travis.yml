language: go

go: "1.13"

os:
- linux
- osx

arch:
- amd64
- arm64

osx_image: xcode11.3

before_script:
- APP_VER=$(git describe --tags --long --dirty)
- APP_VER_SHORT=$(git describe --tags)
- GOOS=$(go env GOOS)
- GOARCH=$(go env GOARCH)
- ARCHIVE="elrond_""$APP_VER_SHORT""_""$GOOS""_""$GOARCH"".tgz"

script:
- ERD_PACKAGE=node
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- ERD_PACKAGE=keygenerator
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- ERD_PACKAGE=logviewer
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- ERD_PACKAGE=termui
- cd $TRAVIS_BUILD_DIR/cmd/$ERD_PACKAGE
- go build -o "$TRAVIS_BUILD_DIR/build/$ERD_PACKAGE" -a -i -ldflags="-X main.appVersion=$APP_VER"
- cd $TRAVIS_BUILD_DIR 
- ARWEN_PATH=$TRAVIS_BUILD_DIR/build/arwen make arwen

- GOOS=$(go env GOOS)
- GOARCH=$(go env GOARCH)
- cd $TRAVIS_BUILD_DIR
- ARWEN_VERSION=$(cat go.mod | grep arwen | sed 's/^.*arwen-wasm-vm *//')
- if [[ "$GOOS" == linux && "$GOARCH" == amd64 ]]; then
    cp -f $GOPATH/pkg/mod/github.com/\!elrond\!network/arwen-wasm-vm@$ARWEN_VERSION/wasmer/libwasmer_linux_amd64.so $TRAVIS_BUILD_DIR/build;
  fi
- if [[ "$GOOS" == linux && "$GOARCH" == arm64 ]]; then
    cp -f $GOPATH/pkg/mod/github.com/\!elrond\!network/arwen-wasm-vm@$ARWEN_VERSION/wasmer/libwasmer_linux_arm64.so $TRAVIS_BUILD_DIR/build;
  fi
- if [[ "$GOOS" == darwin && "$GOARCH" == amd64 ]]; then
    cp -f $GOPATH/pkg/mod/github.com/\!elrond\!network/arwen-wasm-vm@$ARWEN_VERSION/wasmer/libwasmer_darwin_amd64.dylib $TRAVIS_BUILD_DIR/build;
  fi

before_deploy:
- cd "$TRAVIS_BUILD_DIR/build"
- tar czvf "$TRAVIS_BUILD_DIR/$ARCHIVE" *

after_deploy:
- rm -rf "$TRAVIS_BUILD_DIR/build"
- rm -rf "$TRAVIS_BUILD_DIR/$ARCHIVE"

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: hsg7xVo5iOc1bn+g8cljXDt2R2MMDD8JtA//fELlUA54I1BEZ16Fdrz9ZJKYbdhVp0eOEn30Cw4Yk4A2cpIvaZrwMHI/YMDCHtnAXCNBZbooEV5Q7IHceIp/AA7hxOqQjIqa9e2GXDee6wEMiYYsYrJMabJ16EBQ85zLyNY7uegR4YuUFW6rGT9EkUyV56+z+9QOYmRvTVuxZ0Y8vbZ2PlfBFXvlUtU+WXU18nKIkvYqlVDgpbkHO41QmV7BB1KR6cOwwKgWOUq/IqEcsJ13fNXOpaFDQAHm+47O9M55La0prF+yYOc5qCWC8yjm4Qf6Drrkx3Pt6M7FhEtgzjIQcafsNuHgc34uPFt8plwXrkeMD8hvjlaFAseJu/e1RdlMXsdaHOmTZSZQ47VSpMLfO7otzigwKmTgkfxmLQVWYQQAYe5Kyg11Ixwr9bX/RdpdO9AcZbMjw7tB8/gRA1IpwIPXDHEu90gFquWiCZfas1JUvOMT1UU51aFIoNSc5vcYQ4tNBCp7wHyqODZjlrT6zzTX4cTAiwu56Md86ilGAlf3Yd07wd1wAQ8uSrFjpmTE7Jh2penyB2kkv5JH9u9+an7GuatheQ5uwaLtXhVPORsqJQiAYxtG2AG5I+SHI+UZZpoPqRPtGHLPHE3exoC14LVwK2qrBRaHai8xAauv9uM=
  file: "$TRAVIS_BUILD_DIR/$ARCHIVE"
  draft: true
  on:
    tags: true
